# Стандарт кодирования

| | |
|---|---|
| **Продукт** | [ЗАПОЛНИТЬ: наименование СЗИ] |
| **Версия документа** | 1.0 |
| **Дата** | [ЗАПОЛНИТЬ: дата утверждения] |
| **Статус** | Проект |
| **Утверждено** | [ЗАПОЛНИТЬ: должность, ФИО руководителя] |
| **Процесс ГОСТ Р 56939-2024** | 5.8 — Формирование и поддержание правил кодирования |

---

## Содержание

1. [Общие сведения](#1-общие-сведения)
2. [Область применения](#2-область-применения)
3. [Общие правила кодирования](#3-общие-правила-кодирования)
4. [Правила безопасного кодирования](#4-правила-безопасного-кодирования)
5. [Правила по языкам программирования](#5-правила-по-языкам-программирования)
6. [Запрещённые конструкции и паттерны](#6-запрещённые-конструкции-и-паттерны)
7. [Инструменты контроля](#7-инструменты-контроля)
8. [Порядок пересмотра правил](#8-порядок-пересмотра-правил)
9. [История изменений](#9-история-изменений)

---

## 1. Общие сведения

### 1.1. Назначение документа

Настоящий Стандарт кодирования устанавливает правила написания исходного кода продукта [ЗАПОЛНИТЬ: наименование СЗИ], направленные на обеспечение:

- Единообразия кодовой базы.
- Читаемости и сопровождаемости кода.
- Предотвращения типовых уязвимостей и ошибок безопасности.
- Соблюдения требований ГОСТ Р 56939-2024 (п. 5.8).

### 1.2. Нормативные ссылки

| Документ | Описание |
|----------|----------|
| ГОСТ Р 56939-2024, п. 5.8 | Формирование и поддержание правил кодирования |
| ГОСТ Р 71207-2024 | Статический анализ ПО. Общие требования |
| OWASP Secure Coding Practices | Руководство по безопасному кодированию |
| SEI CERT Coding Standards | Стандарты безопасного кодирования (C, C++, Java) |
| CWE/SANS Top 25 | Наиболее опасные ошибки в ПО |

---

## 2. Область применения

### 2.1. Продукты и проекты

Настоящий Стандарт распространяется на весь исходный код продукта [ЗАПОЛНИТЬ: наименование СЗИ], включая:

- Основную кодовую базу.
- Библиотеки и утилиты собственной разработки.
- Скрипты сборки, тестирования и деплоя.
- Конфигурационные файлы, обрабатывающие чувствительные данные.

### 2.2. Языки программирования

| № | Язык | Область применения | Версия |
|---|------|--------------------|--------|
| 1 | [ЗАПОЛНИТЬ: например, Python] | [ЗАПОЛНИТЬ: бэкенд, CLI] | [ЗАПОЛНИТЬ: 3.12+] |
| 2 | [ЗАПОЛНИТЬ: например, TypeScript] | [ЗАПОЛНИТЬ: фронтенд] | [ЗАПОЛНИТЬ: 5.x] |
| 3 | [ЗАПОЛНИТЬ: при необходимости] | [ЗАПОЛНИТЬ] | [ЗАПОЛНИТЬ] |

### 2.3. Исключения

[ЗАПОЛНИТЬ: код, на который стандарт не распространяется, например: сгенерированный код, сторонние библиотеки, legacy-код (с планом миграции)]

---

## 3. Общие правила кодирования

### 3.1. Именование

| Элемент | Правило | Пример |
|---------|---------|--------|
| Переменные | [ЗАПОЛНИТЬ: snake_case / camelCase — зависит от языка] | `user_count`, `userName` |
| Функции/методы | [ЗАПОЛНИТЬ: формат] | `calculate_risk()`, `getRiskLevel()` |
| Классы | PascalCase | `VulnerabilityReport` |
| Константы | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT` |
| Файлы | [ЗАПОЛНИТЬ: формат для каждого языка] | `vulnerability_scanner.py` |
| Приватные поля | [ЗАПОЛНИТЬ: формат] | `_internal_state` |

**Общие принципы:**
- Имена должны отражать назначение, а не реализацию.
- Избегать однобуквенных имён (кроме стандартных итераторов: `i`, `j`, `k`).
- Избегать аббревиатур, кроме общепринятых (`URL`, `HTTP`, `JSON`, `CVE`).
- Булевы переменные — с префиксом `is_`, `has_`, `can_` или аналогичным.

### 3.2. Форматирование

| Параметр | Значение |
|----------|----------|
| Отступы | [ЗАПОЛНИТЬ: пробелы (2/4) или табы] |
| Максимальная длина строки | [ЗАПОЛНИТЬ: 80 / 100 / 120 символов] |
| Кодировка файлов | UTF-8 |
| Окончания строк | LF (Unix-style) |
| Пустая строка в конце файла | Обязательна |
| Trailing whitespace | Запрещён |

### 3.3. Комментирование и документирование

**Обязательное документирование:**
- Все публичные функции, методы и классы — docstring/JSDoc с описанием параметров, возвращаемого значения и исключений.
- Сложная бизнес-логика — комментарий, объясняющий «зачем», а не «что».
- Обходные решения (workarounds) — комментарий со ссылкой на тикет/issue.

**Запрещено:**
- Закомментированный код (удалять, а не комментировать — история хранится в Git).
- Комментарии, дублирующие очевидный код.
- TODO/FIXME без ссылки на тикет в трекере.

### 3.4. Структура файлов

Рекомендуемый порядок элементов в файле:

1. Лицензионный заголовок (при наличии).
2. Импорты / подключения (сгруппированные: стандартная библиотека → сторонние → собственные).
3. Константы.
4. Типы / интерфейсы / модели.
5. Функции / классы.
6. Точка входа (при наличии).

---

## 4. Правила безопасного кодирования

### 4.1. Валидация входных данных

| Правило | Описание |
|---------|----------|
| **Принцип «всё — недоверенное»** | Все данные от пользователя, из внешних API, файлов и БД считаются недоверенными до валидации |
| **Валидация на границе** | Валидировать входные данные как можно раньше — на границе модуля/сервиса |
| **Whitelist > Blacklist** | Предпочитать проверку по списку допустимых значений, а не запрещённых |
| **Типизация** | Использовать строгую типизацию (Pydantic, TypeScript strict mode) |
| **Ограничение размеров** | Устанавливать максимальные размеры для строк, файлов, коллекций |

### 4.2. Защита от инъекций

| Тип инъекции | Мера защиты |
|-------------|-------------|
| SQL Injection | Параметризованные запросы (prepared statements). Запрещено конструирование SQL конкатенацией строк |
| Command Injection | Запрещено использование `os.system()`, `eval()`, `exec()` с пользовательскими данными. Использовать `subprocess` с `shell=False` |
| XSS | Экранирование вывода в HTML. Использовать шаблонизаторы с автоэкранированием. CSP-заголовки |
| Path Traversal | Нормализация путей, проверка на `..`, ограничение базовой директорией |
| SSRF | Валидация URL, запрет обращений к внутренним сетям, whitelist доменов |
| XXE | Отключение обработки внешних сущностей при парсинге XML |

### 4.3. Обработка ошибок и исключений

| Правило | Описание |
|---------|----------|
| **Не раскрывать внутренности** | Сообщения об ошибках для пользователя не должны содержать стек-трейсы, SQL-запросы, пути файловой системы |
| **Логирование** | Все ошибки логируются с достаточным контекстом для диагностики |
| **Fail securely** | При ошибке система переходит в безопасное состояние (deny by default) |
| **Конкретные исключения** | Перехватывать конкретные типы исключений, не использовать голые `except:` / `catch {}` |

### 4.4. Работа с чувствительными данными

| Правило | Описание |
|---------|----------|
| **Запрет хардкода секретов** | Пароли, ключи, токены, сертификаты — только через переменные окружения или хранилище секретов |
| **Не логировать секреты** | Запрещено выводить в логи пароли, токены, ключи, персональные данные |
| **Минимизация хранения** | Хранить чувствительные данные в памяти минимально необходимое время |
| **Безопасное сравнение** | Использовать constant-time comparison для секретов (`hmac.compare_digest`, `crypto.timingSafeEqual`) |
| **Шифрование** | Чувствительные данные в покое — только в зашифрованном виде |

### 4.5. Аутентификация и авторизация

| Правило | Описание |
|---------|----------|
| **Проверка на сервере** | Все проверки авторизации — на стороне сервера, клиентская проверка — только UX |
| **Принцип минимальных привилегий** | Код выполняется с минимальными необходимыми правами |
| **Безопасные сессии** | Использовать криптографически стойкие идентификаторы сессий |
| **Хеширование паролей** | Только bcrypt, scrypt или Argon2id. Запрещены MD5, SHA-1/256 без salt |

### 4.6. Криптография

| Правило | Описание |
|---------|----------|
| **Не изобретать собственную** | Использовать проверенные библиотеки (OpenSSL, libsodium, `cryptography`) |
| **Актуальные алгоритмы** | AES-256-GCM, RSA-2048+, ECDSA P-256+, SHA-256+. Запрещены DES, 3DES, RC4, MD5, SHA-1 |
| **Безопасная генерация случайных чисел** | Только криптографически стойкие ГПСЧ (`secrets`, `crypto.randomBytes`) |
| **Управление ключами** | Ключи хранятся отдельно от зашифрованных данных |

---

## 5. Правила по языкам программирования

### 5.1. Python

> [ЗАПОЛНИТЬ: если Python используется в проекте. Удалить раздел, если не применимо.]

**Руководства-основы:**
- PEP 8 — Style Guide for Python Code
- PEP 257 — Docstring Conventions
- CERT SEI Secure Coding — Python

**Специфичные правила:**

| Правило | Описание |
|---------|----------|
| Версия | Python [ЗАПОЛНИТЬ: 3.12+] |
| Type hints | Обязательны для всех публичных функций и методов |
| Форматирование | [ЗАПОЛНИТЬ: Black / Ruff format] с настройками по умолчанию |
| Линтер | [ЗАПОЛНИТЬ: Ruff / Pylint / Flake8] |
| Импорты | Сортировка через [ЗАПОЛНИТЬ: isort / Ruff] |
| f-строки | Предпочитать f-строки вместо `.format()` и `%` |
| `subprocess` | Только с `shell=False`, аргументы — списком |
| `eval` / `exec` | Запрещены |
| Зависимости | Фиксация версий в `requirements.txt` / `pyproject.toml` |

### 5.2. TypeScript / JavaScript

> [ЗАПОЛНИТЬ: если TypeScript/JavaScript используется в проекте. Удалить раздел, если не применимо.]

**Руководства-основы:**
- TypeScript Handbook — Strict Mode
- OWASP Secure Coding Practices
- Node.js Security Checklist

**Специфичные правила:**

| Правило | Описание |
|---------|----------|
| Версия | TypeScript [ЗАПОЛНИТЬ: 5.x+] |
| Strict mode | `"strict": true` в `tsconfig.json` обязательно |
| Форматирование | [ЗАПОЛНИТЬ: Prettier] с настройками проекта |
| Линтер | [ЗАПОЛНИТЬ: ESLint] с плагинами безопасности |
| `any` | Запрещён, кроме обоснованных случаев с комментарием |
| `eval()` / `Function()` | Запрещены |
| `innerHTML` | Запрещён. Использовать `textContent` или DOMPurify |
| Зависимости | `package-lock.json` / `pnpm-lock.yaml` зафиксированы в репозитории |

### 5.3. [ЗАПОЛНИТЬ: другой язык]

> [ЗАПОЛНИТЬ: добавить раздел для каждого используемого языка по аналогии с предыдущими]

---

## 6. Запрещённые конструкции и паттерны

### 6.1. Универсальные запреты

| № | Запрещённая конструкция | Причина | Альтернатива |
|---|------------------------|---------|-------------|
| 1 | Хардкод секретов в исходном коде | Утечка при компрометации репозитория | Переменные окружения, хранилище секретов |
| 2 | Отключение проверки SSL/TLS-сертификатов (`verify=False`) | MITM-атаки | Корректная настройка доверенных сертификатов |
| 3 | Использование устаревших криптоалгоритмов (MD5, SHA-1, DES) | Криптографическая слабость | AES-256-GCM, SHA-256+, bcrypt/Argon2id |
| 4 | Конкатенация пользовательского ввода в SQL/команды | Инъекции | Параметризованные запросы, `subprocess(shell=False)` |
| 5 | Перехват всех исключений без обработки (`except: pass`) | Скрытие ошибок безопасности | Конкретные типы исключений с логированием |
| 6 | Запись секретов в логи | Утечка через лог-файлы | Маскирование чувствительных данных |
| 7 | Использование `http://` для передачи чувствительных данных | Перехват трафика | Только `https://` |
| 8 | Доверие HTTP-заголовкам от клиента без валидации | Подмена заголовков | Серверная валидация |

### 6.2. Запреты для Python

| № | Запрещённая конструкция | Альтернатива |
|---|------------------------|-------------|
| 1 | `eval()`, `exec()` с недоверенными данными | `ast.literal_eval()` для данных, пересмотр архитектуры |
| 2 | `os.system()` | `subprocess.run(shell=False)` |
| 3 | `pickle.loads()` с недоверенными данными | JSON, MessagePack, protobuf |
| 4 | `yaml.load()` без `Loader=SafeLoader` | `yaml.safe_load()` |
| 5 | `tempfile.mktemp()` | `tempfile.mkstemp()` или `tempfile.NamedTemporaryFile()` |

### 6.3. Запреты для TypeScript / JavaScript

| № | Запрещённая конструкция | Альтернатива |
|---|------------------------|-------------|
| 1 | `eval()`, `Function()`, `setTimeout(string)` | Прямой вызов функций |
| 2 | `innerHTML` с недоверенными данными | `textContent`, DOMPurify |
| 3 | `document.write()` | DOM API |
| 4 | `new RegExp(userInput)` | Экранирование через `escapeRegExp()` |
| 5 | Доступ к `__proto__`, `constructor.prototype` | `Object.create(null)`, `Map` |

---

## 7. Инструменты контроля

### 7.1. Автоматический контроль

| Инструмент | Назначение | Этап | Конфигурация |
|------------|------------|------|-------------|
| [ЗАПОЛНИТЬ: Ruff / ESLint] | Линтинг | Pre-commit, CI | [ЗАПОЛНИТЬ: путь к конфигу] |
| [ЗАПОЛНИТЬ: Black / Prettier] | Форматирование | Pre-commit, CI | [ЗАПОЛНИТЬ: путь к конфигу] |
| [ЗАПОЛНИТЬ: mypy / tsc --strict] | Статическая типизация | CI | [ЗАПОЛНИТЬ: путь к конфигу] |
| [ЗАПОЛНИТЬ: SonarQube / Semgrep] | SAST (правила безопасности) | CI | [ЗАПОЛНИТЬ: путь к конфигу] |
| [ЗАПОЛНИТЬ: pre-commit hooks] | Git-хуки | Pre-commit | `.pre-commit-config.yaml` |

### 7.2. Ручной контроль

| Мероприятие | Описание | Периодичность |
|-------------|----------|---------------|
| Code review | Проверка соблюдения стандарта при каждом pull request / merge request | Каждый PR/MR |
| Аудит SAST-правил | Проверка актуальности и полноты правил анализаторов | [ЗАПОЛНИТЬ: раз в квартал] |
| Пересмотр запрещённых конструкций | Обновление списка на основе новых CVE и CWE | [ЗАПОЛНИТЬ: раз в полгода] |

### 7.3. Интеграция в CI/CD

Контроль соблюдения стандарта кодирования обязательно включён в CI/CD-конвейер:

1. **Pre-commit** — локальная проверка форматирования и линтинга перед коммитом.
2. **CI pipeline** — автоматическая проверка при каждом push и pull request:
   - Линтинг (все языки).
   - Проверка типов.
   - SAST-сканирование с правилами безопасности.
3. **Блокировка мержа** — PR/MR не может быть влит при ошибках линтера или SAST.

---

## 8. Порядок пересмотра правил

### 8.1. Периодичность

| Тип пересмотра | Периодичность | Инициатор |
|----------------|---------------|-----------|
| Плановый | [ЗАПОЛНИТЬ: не реже 1 раза в год] | Руководитель РБПО |
| Внеплановый (новый язык/фреймворк) | По факту принятия решения | Архитектор |
| Внеплановый (инцидент безопасности) | По факту инцидента | Инженер по безопасности |
| Внеплановый (новый CVE/CWE) | По факту публикации | Инженер по безопасности |

### 8.2. Процедура внесения изменений

1. **Инициация** — создание запроса на изменение стандарта с обоснованием.
2. **Согласование** — рассмотрение [ЗАПОЛНИТЬ: ответственным лицом/комитетом].
3. **Реализация** — обновление документа и конфигураций инструментов.
4. **Информирование** — уведомление всех разработчиков об изменениях.
5. **Переходный период** — [ЗАПОЛНИТЬ: срок, например 2 недели] на адаптацию существующего кода (при необходимости).

### 8.3. Журнал пересмотров

| Дата | Инициатор | Изменение | Основание |
|------|-----------|-----------|-----------|
| [ЗАПОЛНИТЬ] | [ЗАПОЛНИТЬ] | [ЗАПОЛНИТЬ] | [ЗАПОЛНИТЬ] |

---

## 9. История изменений

| Версия | Дата | Описание изменений | Автор |
|--------|------|--------------------|-------|
| 1.0 | [ЗАПОЛНИТЬ: дата] | Первая версия документа | [ЗАПОЛНИТЬ: ФИО] |
